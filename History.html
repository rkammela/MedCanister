<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Single page template</title>
	<link rel="stylesheet" href="https://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.css" />
	<script src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="js/jsrender.js"></script>
	<script src="https://code.jquery.com/mobile/1.1.1/jquery.mobile-1.1.1.min.js"></script>
	<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>

	<link href="css/fullcalendar.css" rel="stylesheet">
	<link href="cssjq/jquery-ui.css" rel="stylesheet">
	<link href="css/fullcalendar.print.css" rel="stylesheet" media="print">
	<script src="js/moment.min.js"></script>

	<script src="js/fullcalendar.min.js"></script>


	<style>

		body {
			margin: 40px 10px;
			padding: 0;
			font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
			font-size: 14px;
		}

		#details{position: relative;top: 50%; color: #4379cf; text-align:center;  width:100%; font-weight: bold; }

		#calendar {
			max-width: 900px;
			margin: 0 auto;
		}

	</style>


</head>

<body>

<script id="GolferTemplate1" type="text/html">
	{{:key}}: <b>{{:taken}}</b> <i>{{:timestamp}}</i> <br />
</script>

<script id="GolferTemplate2" type="text/html">
	<tr>
		<td>{{:DateID}}</td>
		<td><b>{{:Taken}}</b></td>
	</tr>
</script>

<br>
<div id='calendar'></div>
<br>
<br>
<br>
<br>
<br>
<div id="details"></div>
<script>

	function predicatBy(prop){
		return function(a,b){
			if( a[prop] > b[prop]){
				return -1;
			}else if( a[prop] < b[prop] ){
				return 1;
			}
			return 0;
		}
	}


	var jsonObj = [];
	var myDataRef = new Firebase('https://medtrac.firebaseio.com/DailyMedLog');



	function ReadHistory(){
		myDataRef.orderByChild("timestamp").limitToLast(100).once('value', function(snapshot) {
			var response = snapshot.val();


			$.each(response, function(key, value){

				//document.getElementById("GolferTable").innerHTML = JSON.stringify(key, undefined, 2);

				item = {}
				item ["DateID"] = key;
				item ["Taken"] = value.taken;
				item ["Timestamp"] = value.timestamp;
				jsonObj.push(item);


			});

			console.log("refreshed");
			console.log(jsonObj);

			//$('#calendar').fullCalendar('updateEvent', jsonObj);
			//$('#calendar').fullCalendar('addEventSource', jsonObj );

		});
	}

	function LookForChanges()
	{
		myDataRef.on('child_added', function(snapshot) {
			var response = snapshot.val();
			jsonObj = [];
			//ReadHistory();
		});

		myDataRef.on('child_removed', function(snapshot) {
			var response = snapshot.val();
			jsonObj = [];
			ReadHistory();
		});

		myDataRef.on('child_changed', function(snapshot) {
			var response = snapshot.val();
			jsonObj = [];
			ReadHistory();
		});
	}


	$(document).ready(function() {


			var	movies =		[
			{
				title: 'All Day Event',
				start: '2015-02-01'
			},
			{
				title: 'Long Event',
				start: '2015-02-07',
				end: '2015-02-10'
			},
			{
				id: 999,
				title: 'Repeating Event',
				start: '2015-02-09T16:00:00'
			},
			{
				id: 999,
				title: 'Repeating Event',
				start: '2015-02-16T16:00:00'
			},
			{
				title: 'Conference',
				start: '2015-02-11',
				end: '2015-02-13'
			},
			{
				title: 'Meeting',
				start: '2015-02-12T10:30:00',
				end: '2015-02-12T12:30:00'
			},
			{
				title: 'Lunch',
				start: '2015-02-12T12:00:00'
			},
			{
				title: 'Meeting',
				start: '2015-02-12T14:30:00'
			},
			{
				title: 'Happy Hour',
				start: '2015-02-12T17:30:00'
			},
			{
				title: 'Dinner',
				start: '2015-02-12T20:00:00'
			},
			{
				title: 'Birthday Party',
				start: '2015-02-13T07:00:00'
			},
			{
				title: 'Click for Google',
				url: 'http://google.com/',
				start: '2015-02-28'
			}
		]


		myDataRef.orderByChild("timestamp").limitToLast(100).once('value', function(snapshot) {
			var response = snapshot.val();


			$.each(response, function(key, value){

				//document.getElementById("GolferTable").innerHTML = JSON.stringify(key, undefined, 2);
				var d = new Date();
				d.setTime(value.timestamp * 1000);


				item = {}


				//item ["start"] = key;
				if (value.taken == "yes"){
					//item ["title"] = "Taken at " + d.toLocaleTimeString();
					item ["start"] = d;
					item ["title"] = "Taken";
					item ["description"] = "Taken 1ml";
					item["color"] = "green";
				}
				else {
					item ["start"] = d;
					item ["title"] = "Not taken";
					item ["description"] = "Not taken yet";
					item["color"] = "red";
					item["allDay"] = true;
				}
				item["Timestamp"] = value.timestamp;
				jsonObj.push(item);


			});

			console.log(response.length);
			console.log(jsonObj);

			var cd = new Date();

			$('#calendar').fullCalendar({
				header: {
					left: 'title',
					center: '',
					right: 'today,prev,next'
				},
				defaultDate: cd,
				theme: false,
				editable: true,
				eventLimit: true, // allow "more" link when too many events
				dayClick: function() {
					//alert('a day has been clicked!');
				},
				events: jsonObj,
				eventClick: function(calEvent, jsEvent, view) {
					var ed = new Date();
					ed.setTime(calEvent.start);
					//$("#details").html('Event: ' + calEvent.title + '&nbsp;' + 'Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY  + '&nbsp;' + 'View: ' + view.name);
					$("#details").html( ed + " <br><br> " +  calEvent.description);
					// change the border color just for fun
					//$(this).css('border-color', 'yellow');

				}
			});


			LookForChanges();

		});





	});

</script>

</body>
</html>